<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Finalizar Leitura</title>
  <link rel="stylesheet" href="../css/Finalizar.css">
</head>
<body>
  <div class="container">
    <h2>✅ Finalizar Leitura</h2>
    <form id="form-finalizar-leitura">
      <label for="livroSelecionado">Selecione o livro:</label>
      <select id="livroSelecionado" required></select>
      <button type="submit">Marcar como Lido</button>
    </form>
     <button class="voltar" onclick="window.location.href='inserirLeitura.html'">Voltar</button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
  const formFinalizar = document.getElementById("form-finalizar-leitura");
  const selectLivro = document.getElementById("livroSelecionado");

  // 1. Carregar livros ao iniciar
  function carregarLivros() {
    const leituras = JSON.parse(localStorage.getItem("leituras")) || [];
    selectLivro.innerHTML = ""; // Limpa o select

    if (leituras.length === 0) {
      const option = document.createElement("option");
      option.textContent = "Nenhum livro cadastrado";
      option.disabled = true;
      option.selected = true;
      selectLivro.appendChild(option);
      selectLivro.disabled = true;
    } else {
      leituras.forEach((livro, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.textContent = `${livro.titulo} (Pág. ${livro.paginaAtual}/${livro.totalPaginas})`;
        selectLivro.appendChild(option);
      });
    }
  }

  // 2. Função principal para marcar como lido
  function finalizarLeitura() {
    const leituras = JSON.parse(localStorage.getItem("leituras")) || [];
    const livroIndex = parseInt(selectLivro.value);

    // Verificações críticas
    if (isNaN(livroIndex)) {
      alert("Selecione um livro válido!");
      return false;
    }

    const livro = leituras[livroIndex];
    
    if (!livro) {
      alert("Livro não encontrado!");
      return false;
    }

    // Atualiza o progresso
    livro.paginaAtual = livro.totalPaginas;
    livro.concluido = true;
    livro.dataConclusao = new Date().toLocaleDateString();

    // Salva no localStorage
    localStorage.setItem("leituras", JSON.stringify(leituras));
    
    alert(`✅ "${livro.titulo}" finalizado com sucesso!`);
    return true;
  }

  // 3. Event Listeners
  formFinalizar.addEventListener("submit", function(e) {
    e.preventDefault();
    if (finalizarLeitura()) {
      carregarLivros(); // Atualiza a lista
    }
  });

  // Inicialização
  carregarLivros();
});
  </script>
</body>
</html>